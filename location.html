<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Location Extractor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .upload-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f1f5f9;
        }

        .upload-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }

        #fileInput {
            display: none;
        }

        .camera-section {
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        #cameraView {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 15px;
            background: #1a202c;
            margin: 20px auto;
            display: block;
        }

        .camera-controls {
            margin: 20px 0;
        }

        .preview-section {
            margin: 30px 0;
            text-align: center;
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-item {
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #2d3748;
            display: inline-block;
            min-width: 80px;
        }

        .info-value {
            color: #4a5568;
            word-break: break-word;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #e53e3e;
        }

        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            border-left: 4px solid #48bb78;
        }

        .permission-info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3182ce;
        }

        .map-container {
            margin-top: 20px;
            height: 300px;
            background: #e2e8f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .upload-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 200px;
                justify-content: center;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            #cameraView {
                height: 250px;
            }
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Photo Location Extractor</h1>
        
        <div class="permission-info">
            <strong>üìç Location Permission Required:</strong> This app needs access to your camera and location to capture photos with GPS data. Please allow permissions when prompted.
        </div>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px; color: #64748b;">Capture or Upload Photo</h2>
            <p style="margin-bottom: 20px; color: #64748b;">Take a new photo with location data or upload an existing one</p>
            
            <div class="upload-buttons">
                <button class="btn btn-primary" id="openCameraBtn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" />
                    </svg>
                    Open Camera
                </button>
                <button class="btn btn-secondary" onclick="$('#fileInput').click()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                    </svg>
                    Upload Photo
                </button>
            </div>
            
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="camera-section" id="cameraSection">
            <h3 style="margin-bottom: 20px; color: #4a5568;">üì∑ Camera View</h3>
            <video id="cameraView" autoplay playsinline></video>
            <div class="camera-controls">
                <button class="btn btn-success" id="captureBtn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
                    </svg>
                    Capture Photo
                </button>
                <button class="btn btn-secondary" id="closeCameraBtn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                    </svg>
                    Close Camera
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            Processing photo and extracting location data...
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="preview-section" id="previewSection">
            <img id="imagePreview" class="image-preview" alt="Photo preview">
            
            <div class="info-grid" id="infoGrid">
                <div class="info-card">
                    <h3>üìç Location Information</h3>
                    <div id="locationInfo">
                        <div class="info-item">
                            <span class="info-label">Latitude:</span>
                            <span class="info-value" id="latitude">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Longitude:</span>
                            <span class="info-value" id="longitude">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Address:</span>
                            <span class="info-value" id="address">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">City:</span>
                            <span class="info-value" id="city">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">State:</span>
                            <span class="info-value" id="state">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Country:</span>
                            <span class="info-value" id="country">-</span>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h3>üïí Time Information</h3>
                    <div id="timeInfo">
                        <div class="info-item">
                            <span class="info-label">Captured:</span>
                            <span class="info-value" id="dateTaken">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Time:</span>
                            <span class="info-value" id="timeTaken">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Timezone:</span>
                            <span class="info-value" id="timezone">-</span>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h3>üì∑ Photo Information</h3>
                    <div id="cameraInfo">
                        <div class="info-item">
                            <span class="info-label">Source:</span>
                            <span class="info-value" id="photoSource">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Device:</span>
                            <span class="info-value" id="device">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Resolution:</span>
                            <span class="info-value" id="resolution">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location:</span>
                            <span class="info-value" id="locationSource">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <p>üìç Map view would appear here with the photo location</p>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let currentLocation = null;

        $(document).ready(function() {
            // Get current location on page load
            getCurrentLocation();

            // Handle file input changes
            $('#fileInput').change(function() {
                const file = this.files[0];
                if (file) {
                    processUploadedImage(file);
                }
            });

            // Open camera button
            $('#openCameraBtn').click(function() {
                openCamera();
            });

            // Capture photo button
            $('#captureBtn').click(function() {
                capturePhoto();
            });

            // Close camera button
            $('#closeCameraBtn').click(function() {
                closeCamera();
            });

            function getCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            currentLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: position.timestamp
                            };
                        },
                        function(error) {
                            console.log('Location access denied or unavailable:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutes
                        }
                    );
                }
            }

            async function openCamera() {
                try {
                    // Request camera permission with high resolution
                    const constraints = {
                        video: {
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            facingMode: 'environment' // Use back camera on mobile
                        }
                    };

                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    const video = $('#cameraView')[0];
                    video.srcObject = stream;
                    
                    $('#cameraSection').show();
                    $('#openCameraBtn').text('Camera Active').prop('disabled', true);
                    
                    showSuccess('Camera access granted! You can now capture photos.');
                } catch (error) {
                    console.error('Camera access error:', error);
                    showError('Camera access denied. Please allow camera permission and try again.');
                }
            }

            function capturePhoto() {
                const video = $('#cameraView')[0];
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Set canvas size to video dimensions
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw current video frame to canvas
                ctx.drawImage(video, 0, 0);

                // Convert to blob and process
                canvas.toBlob(function(blob) {
                    // Create a file-like object with current timestamp
                    const file = new File([blob], `captured_photo_${Date.now()}.jpg`, {
                        type: 'image/jpeg'
                    });

                    processCapturedImage(canvas.toDataURL('image/jpeg', 0.9), file);
                }, 'image/jpeg', 0.9);

                closeCamera();
            }

            function closeCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                $('#cameraSection').hide();
                $('#openCameraBtn').text('Open Camera').prop('disabled', false);
            }

            function processUploadedImage(file) {
                $('#loading').show();
                $('#errorMessage').hide();
                $('#successMessage').hide();
                $('#previewSection').hide();

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showError('Please select a valid image file.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        $('#imagePreview').attr('src', e.target.result);
                        $('#previewSection').show();
                        
                        // Try to extract EXIF data first
                        extractEXIFData(img, file, false);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function processCapturedImage(dataUrl, file) {
                $('#loading').show();
                $('#errorMessage').hide();
                $('#successMessage').hide();
                $('#previewSection').hide();

                const img = new Image();
                img.onload = function() {
                    $('#imagePreview').attr('src', dataUrl);
                    $('#previewSection').show();
                    
                    // For captured photos, use current location since EXIF won't have GPS
                    extractEXIFData(img, file, true);
                };
                img.src = dataUrl;
            }

            function extractEXIFData(img, file, isCaptured) {
                $('#photoSource').text(isCaptured ? 'Camera Capture' : 'Uploaded File');
                $('#device').text(navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop/Laptop');
                $('#resolution').text(`${img.naturalWidth} √ó ${img.naturalHeight} pixels`);

                if (isCaptured) {
                    // For captured photos, use current location and current time
                    if (currentLocation) {
                        $('#latitude').text(currentLocation.latitude.toFixed(6));
                        $('#longitude').text(currentLocation.longitude.toFixed(6));
                        $('#locationSource').text(`Device GPS (¬±${Math.round(currentLocation.accuracy)}m accuracy)`);
                        
                        getLocationInfo(currentLocation.latitude, currentLocation.longitude);
                        
                        // Set current time
                        const now = new Date();
                        $('#dateTaken').text(now.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }));
                        $('#timeTaken').text(now.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }));
                        $('#timezone').text(Intl.DateTimeFormat().resolvedOptions().timeZone);

                        $('#loading').hide();
                        showSuccess('Photo captured with current location data!');
                    } else {
                        $('#loading').hide();
                        showError('Current location not available. Please enable location services.');
                        $('#locationSource').text('Location services disabled');
                    }
                } else {
                    // For uploaded photos, try to extract EXIF data
                    EXIF.getData(img, function() {
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                        const dateTime = EXIF.getTag(this, "DateTime");
                        const dateTimeOriginal = EXIF.getTag(this, "DateTimeOriginal");
                        const make = EXIF.getTag(this, "Make");
                        const model = EXIF.getTag(this, "Model");

                        $('#loading').hide();

                        if (lat && lon && latRef && lonRef) {
                            // Photo has GPS data
                            const latitude = convertGPSToDecimal(lat, latRef);
                            const longitude = convertGPSToDecimal(lon, lonRef);

                            $('#latitude').text(latitude.toFixed(6));
                            $('#longitude').text(longitude.toFixed(6));
                            $('#locationSource').text('Photo EXIF GPS Data');

                            getLocationInfo(latitude, longitude);
                            showSuccess('Location data extracted from photo EXIF!');
                        } else {
                            // No GPS data in photo, use current location as fallback
                            if (currentLocation) {
                                $('#latitude').text(currentLocation.latitude.toFixed(6));
                                $('#longitude').text(currentLocation.longitude.toFixed(6));
                                $('#locationSource').text('Current Device Location (Photo has no GPS data)');
                                
                                getLocationInfo(currentLocation.latitude, currentLocation.longitude);
                                showSuccess('Photo has no GPS data. Using your current location instead.');
                            } else {
                                $('#latitude').text('No GPS data available');
                                $('#longitude').text('No GPS data available');
                                $('#address').text('Location data not available');
                                $('#city').text('-');
                                $('#state').text('-');
                                $('#country').text('-');
                                $('#locationSource').text('No GPS data found');
                                
                                showError('Photo has no GPS data and current location is unavailable. Enable location services for better results.');
                            }
                        }

                        // Extract time information
                        const photoDate = dateTimeOriginal || dateTime;
                        if (photoDate) {
                            const formattedDate = formatDateTime(photoDate);
                            $('#dateTaken').text(formattedDate.date);
                            $('#timeTaken').text(formattedDate.time);
                            $('#timezone').text('Photo EXIF timestamp');
                        } else {
                            $('#dateTaken').text('Not available in EXIF');
                            $('#timeTaken').text('Not available in EXIF');
                            $('#timezone').text('-');
                        }

                        // Update device info with EXIF data if available
                        if (make && model) {
                            $('#device').text(`${make} ${model}`);
                        }
                    });
                }
            }

            function convertGPSToDecimal(gpsCoordinate, gpsRef) {
                const degrees = gpsCoordinate[0];
                const minutes = gpsCoordinate[1];
                const seconds = gpsCoordinate[2];
                
                let decimal = degrees + (minutes / 60) + (seconds / 3600);
                
                if (gpsRef === "S" || gpsRef === "W") {
                    decimal = decimal * -1;
                }
                
                return decimal;
            }

            function getLocationInfo(lat, lon) {
                $.ajax({
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
                    method: 'GET',
                    success: function(data) {
                        if (data && data.display_name) {
                            $('#address').text(data.display_name);
                            
                            const address = data.address || {};
                            $('#city').text(address.city || address.town || address.village || address.suburb || '-');
                            $('#state').text(address.state || address.province || address.region || address.county || '-');
                            $('#country').text(address.country || '-');
                        } else {
                            $('#address').text('Address not found for these coordinates');
                            $('#city').text('Unknown');
                            $('#state').text('Unknown');
                            $('#country').text('Unknown');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Geocoding error:', error);
                        $('#address').text('Unable to fetch address (service may be temporarily unavailable)');
                        $('#city').text('Service unavailable');
                        $('#state').text('Service unavailable');
                        $('#country').text('Service unavailable');
                    }
                });
            }

            function formatDateTime(dateTimeStr) {
                const cleanStr = dateTimeStr.replace(/:/g, (match, offset) => {
                    return offset < 10 ? '-' : ':';
                });
                
                const date = new Date(cleanStr);
                
                if (isNaN(date.getTime())) {
                    return { date: dateTimeStr, time: 'Invalid date' };
                }

                return {
                    date: date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }),
                    time: date.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                };
            }

            function showError(message) {
                $('#errorMessage').text(message).show();
                setTimeout(() => $('#errorMessage').fadeOut(), 8000);
            }

            function showSuccess(message) {
                $('#successMessage').text(message).show();
                setTimeout(() => $('#successMessage').fadeOut(), 5000);
            }

            // Drag and drop functionality
            $('.upload-section').on('dragover', function(e) {
                e.preventDefault();
                $(this).css('border-color', '#667eea');
            });

            $('.upload-section').on('dragleave', function(e) {
                e.preventDefault();
                $(this).css('border-color', '#cbd5e0');
            });

            $('.upload-section').on('drop', function(e) {
                e.preventDefault();
                $(this).css('border-color', '#cbd5e0');
                
                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    processUploadedImage(files[0]);
                }
            });

            // Clean up camera stream when page unloads
            $(window).on('beforeunload', function() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            });
        });
    </script>
</body>
</html>